<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Produtos | Alfaiataria</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
<header class="main-header">
    <div class="logo">Alfaiataria</div>
    <nav>
        <ul class="nav-links">
            <li><a href="dashboard.html">Dashboard</a></li>
            <li><a href="produtos.html" class="active">Produtos</a></li>
            <li id="menu-usuarios"><a href="usuarios.html">Usuários</a></li>
            <li id="menu-grupos"><a href="grupos.html">Grupos</a></li>
            <li id="menu-vendas"><a href="vendas.html">Vendas</a></li>
            <li><a href="index.html" class="logout">Sair</a></li>
        </ul>
    </nav>
</header>

<main class="content fade-in">
    <h1>Produtos</h1>

    <!-- FORMULÁRIO (somente admin/vendedor) -->
    <form class="crud-form" id="form-produto">
        <input type="text" id="nome-produto" placeholder="Nome do produto" required>
        <input type="text" id="categoria-produto" placeholder="Categoria" required>
        <input type="number" id="preco-produto" placeholder="Preço (R$)" required>
        <button class="btn" type="submit">Adicionar</button>
    </form>

    <table class="crud-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Nome</th>
                <th>Categoria</th>
                <th>Preço</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody id="lista-produtos">
            <tr><td colspan="5">Carregando produtos...</td></tr>
        </tbody>
    </table>
</main>

<!-- ========== MODAL DE EDIÇÃO ========== -->
<div id="modal-editar" class="modal" style="display:none;">
    <div class="modal-content">
        <h2>Editar Produto</h2>

        <input type="text" id="edit-nome">
        <input type="text" id="edit-categoria">
        <input type="number" id="edit-preco">

        <button class="btn" id="salvar-edicao">Salvar</button>
        <button class="btn danger" id="cancelar-edicao">Cancelar</button>
    </div>
</div>

<script>
const API = "http://127.0.0.1:8000/api";

let usuarioLogado = null;
let grupo = null;

// ================================
// VERIFICAR LOGIN
// ================================
document.addEventListener("DOMContentLoaded", () => {
    usuarioLogado = JSON.parse(localStorage.getItem("usuario"));

    if (!usuarioLogado) {
        alert("Você precisa estar logado!");
        window.location.href = "index.html";
        return;
    }

    grupo = usuarioLogado.grupo_id;

    // ================================
    // CONTROLE DE MENUS
    // ================================
    if (grupo === 3) { // Cliente
        document.getElementById("menu-vendas").style.display = "none";
        document.getElementById("menu-usuarios").style.display = "none";
        document.getElementById("menu-grupos").style.display = "none";
    }

    // FORMULÁRIO: somente admin e vendedor
    if (grupo === 3) {
        document.getElementById("form-produto").style.display = "none";
    }

    carregarProdutos();
});

// ================================
// CARREGAR PRODUTOS
// ================================
async function carregarProdutos() {
    const tabela = document.getElementById("lista-produtos");
    tabela.innerHTML = "<tr><td colspan='5'>Carregando...</td></tr>";

    const resp = await fetch(`${API}/produtos`);
    const produtos = await resp.json();

    tabela.innerHTML = "";

    produtos.forEach(p => {

        let botoes = "";

        // ADMIN e VENDEDOR — editar + excluir (excluir apenas admin)
        if (grupo === 1 || grupo === 2) {
            botoes += `
                <button class="btn small edit editar" data-id="${p.id}" data-nome="${p.nome}" data-cat="${p.categoria}" data-preco="${p.preco}">
                    Editar
                </button>
            `;
            if (grupo === 1) {
                botoes += `
                <button class="btn small danger excluir" data-id="${p.id}">
                    Excluir
                </button>`;
            }
        }

        // CLIENTE — comprar
        if (grupo === 3) {
            botoes = `
                <button class="btn small buy comprar" data-id="${p.id}">
                    Comprar
                </button>
            `;
        }

        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${p.id}</td>
            <td>${p.nome}</td>
            <td>${p.categoria}</td>
            <td>R$ ${p.preco.toFixed(2)}</td>
            <td>${botoes}</td>
        `;
        tabela.appendChild(tr);
    });
}

// ================================
// ADICIONAR PRODUTO
// ================================
document.getElementById("form-produto")?.addEventListener("submit", async (e) => {
    e.preventDefault();

    const nome = document.getElementById("nome-produto").value;
    const categoria = document.getElementById("categoria-produto").value;
    const preco = parseFloat(document.getElementById("preco-produto").value);

    const resp = await fetch(`${API}/produtos`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ nome, categoria, preco })
    });

    if (!resp.ok) {
        alert("Erro ao cadastrar!");
        return;
    }

    alert("Produto cadastrado!");
    e.target.reset();
    carregarProdutos();
});

// ================================
// AÇÕES: EDITAR / EXCLUIR / COMPRAR
// ================================
document.addEventListener("click", async (e) => {

    // ==================== EDITAR ====================
    if (e.target.classList.contains("editar")) {
        const id = e.target.dataset.id;

        document.querySelector("#modal-editar").style.display = "flex";

        document.querySelector("#edit-nome").value = e.target.dataset.nome;
        document.querySelector("#edit-categoria").value = e.target.dataset.cat;
        document.querySelector("#edit-preco").value = e.target.dataset.preco;

        document.querySelector("#salvar-edicao").onclick = async () => {

            const dados = {
                nome: document.querySelector("#edit-nome").value,
                categoria: document.querySelector("#edit-categoria").value,
                preco: parseFloat(document.querySelector("#edit-preco").value),
            };

            const resp = await fetch(`${API}/produtos/${id}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(dados)
            });

            if (!resp.ok) {
                alert("Erro ao editar!");
                return;
            }

            alert("Produto atualizado!");
            document.querySelector("#modal-editar").style.display = "none";
            carregarProdutos();
        };
    }

    // ==================== CANCELAR EDIÇÃO ====================
    if (e.target.id === "cancelar-edicao") {
        document.querySelector("#modal-editar").style.display = "none";
    }

    // ==================== EXCLUIR (SOMENTE ADMIN) ====================
    if (e.target.classList.contains("excluir")) {
        if (grupo !== 1) return; // segurança extra

        if (!confirm("Excluir produto?")) return;

        const id = e.target.dataset.id;

        const resp = await fetch(`${API}/produtos/${id}`, { method: "DELETE" });

        if (!resp.ok) {
            alert("Erro ao excluir!");
            return;
        }

        alert("Produto excluído!");
        carregarProdutos();
    }

    // ==================== COMPRAR (CLIENTE) ====================
    if (e.target.classList.contains("comprar")) {
        alert("Produto adicionado ao carrinho! (função futura)");
    }
});
</script>

</body>
</html>
